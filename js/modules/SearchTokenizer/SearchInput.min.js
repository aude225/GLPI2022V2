import SearchTokenizer from"./SearchTokenizer.js";export default class SearchInput{constructor(t,e){this.original_input=$(t);this.options=Object.assign({backspace_action:"edit",tokenizer_options:{},filter_on_type:true},e||{});this.tokenizer=new SearchTokenizer(e.allowed_tags||{},e.drop_unallowed_tags||false,e.tokenizer_options);this.displayed_input=$(`\n         <div class="form-control search-input d-flex" tabindex="0"></div>\n      `).insertBefore(t);this.displayed_input.append(`<span class="search-input-tag-input flex-grow-1" contenteditable="true"></span>`);this.original_input.hide();this.last_result=null;this.registerListeners()}registerListeners(){const t=this.displayed_input;t.on("input change",(()=>{if(this.isSelectionUntagged()){this.refreshPopover()}}));t.popover(Object.assign({trigger:"manual",html:true,container:this.displayed_input.parent(),customClass:"search-input-popover shadow",placement:"bottom",popperConfig:{placement:"bottom-start"},delay:{hide:300},sanitize:false,content:()=>this.getPopoverContent()},this.options.popover||{}));t.parent().on("mousedown",".search-input-popover",(t=>{t.preventDefault()}));t.parent().on("click",".search-input-popover .tags-list li",(t=>{t.preventDefault();t.stopPropagation();const e=$(t.target).closest("li").attr("data-tag");const n=$('<span class="search-input-tag-input">'+e.trim()+":</span>").insertBefore($(".search-input-tag-input:last-of-type"));const s=this.getSelectedNode();$(s).text("");const i=this.tagifyInputNode(n);this.makeTagEditable(i);i.focus()}));t.parent().on("click",".search-input-popover .tags-list li button.tag-prefix",(t=>{t.preventDefault();t.stopPropagation();const e=$(t.target).closest("button.tag-prefix").attr("data-prefix");const n=$(t.target).closest("li").attr("data-tag");const s=$('<span class="search-input-tag-input">'+(e||"")+n.trim()+":</span>").insertBefore($(".search-input-tag-input:last-of-type"));const i=this.getSelectedNode();$(i).text("");const o=this.tagifyInputNode(s);this.makeTagEditable(o);o.focus()}));t.parent().on("click",".search-input-popover .term-suggestions-list li",(e=>{e.preventDefault();const n=$(e.target).closest("li");const s=n.closest("ul").attr("data-tag");const i=n.text().trim();const o=t.find('.search-input-tag-input[data-tag="'+s+'"]');o.text(`${s}:${i}`);this.tagifyInputNode(o);this.placeCaretInDefaultInput()}));t.on("input click focus",(()=>{this.refreshPopover();t.popover("show")}));$(document.body).on("click",(e=>{if($(e.target).closest(t,this.original_input,t.parent().find(".search-input-popover")).length===0){t.popover("hide")}}));t.on("blur",".search-input-tag-input",(t=>{const e=$(t.target).closest(".search-input-tag-input");this.tagifyInputNode(e)}));t.on("keydown",".search-input-tag-input",(e=>{if(e.keyCode===9){e.preventDefault()}else if(e.keyCode===8){const t=this.getSelectedNode();if(!t||t.classList.contains("search-input-tag-input")){const n=document.getSelection();if(!n.anchorNode.isSameNode(n.focusNode)){e.preventDefault()}if(n.anchorOffset===0){if(this.options.backspace_action==="remove"){const e=t.previousSibling;if(e){e.remove();this.displayed_input.trigger("result_change")}}else if(this.options.backspace_action==="edit"){const n=$(t.previousSibling);if(n){this.makeTagEditable(n);e.preventDefault()}}}}}else if(e.keyCode===13){e.preventDefault();const n=t.parent().find(".search-input-popover ul");if(n.length>0){const t=n.find("li.active");if(t.length>0){const e=t.find("button.tag-prefix.active");if(e.length>0){e.click()}else{t.click()}}else{this.tagifySelectedNode()}}else{this.tagifySelectedNode()}}else if(e.keyCode===40){const e=t.parent().find(".search-input-popover ul");if(e.length>0){const t=e.find("li.active");if(t.length===0){e.find("li:first-of-type").addClass("active")}else{const e=t.next();if(e.length>0){t.removeClass("active");e.addClass("active")}}e.find("button.tag-prefix").removeClass("active")}}else if(e.keyCode===38){const e=t.parent().find(".search-input-popover ul");if(e.length>0){const t=e.find("li.active");if(t.length===0){e.find("li:last-of-type").addClass("active")}else{const e=t.prev();if(e.length>0){t.removeClass("active");e.addClass("active")}}e.find("button.tag-prefix").removeClass("active")}}else if(e.keyCode===37){const e=t.parent().find(".search-input-popover ul");if(e.length>0){const t=e.find("li.active");if(t.length>0){const e=t.find("button.tag-prefix.active");if(e.length===0){t.find("button.tag-prefix:last-of-type").addClass("active")}else{const t=e.prev();e.removeClass("active");if(t.length>0){t.addClass("active")}}}}}else if(e.keyCode===39){const e=t.parent().find(".search-input-popover ul");if(e.length>0){const t=e.find("li.active");if(t.length>0){const e=t.find("button.tag-prefix.active");if(e.length===0){t.find("button.tag-prefix:first-of-type").addClass("active")}else{const t=e.next();e.removeClass("active");if(t.length>0){t.addClass("active")}}}}}}));t.on("keypress",".search-input-tag-input",(t=>{if(t.keyCode===13){t.preventDefault()}}));t.on("keyup","search-input-tag-input",(t=>{if(t.keyCode===9){t.preventDefault();this.tagifySelectedNode()}}));t.on("click",".search-input-tag",(t=>{const e=$(t.target).closest(".search-input-tag");this.makeTagEditable(e)}));t.on("click",".search-input-tag i",(t=>{$(t.target).closest(".search-input-tag").remove();this.displayed_input.trigger("result_change")}));t.on("result_change",(t=>{let e=this.getRawInput();const n=this.tokenizer.tokenize(e);const s=JSON.stringify(n)!==JSON.stringify(this.last_result);if(this.options.on_result_change&&s){this.options.on_result_change(t,n)}this.last_result=n}))}tagifySelectedNode(){const t=$(this.getSelectedNode());if(t&&this.isSelectionUntagged()){return this.tagifyInputNode(t)}return null}tokenToTagHtml(t){const e=t.tag?`<b>${t.exclusion?this.tokenizer.EXCLUSION_PREFIX:""}${t.prefix?t.prefix:""}${t.tag}</b>:`:"";let n=null;if(this.tokenizer.options.custom_prefixes[t.prefix]){n=this.tokenizer.options.custom_prefixes[t.prefix].token_color||null}else if(t.exclusion){n="#80000080"}const s=$("html").css("--is-dark").trim()==="true";const i=$(document.body).css("color");let o="";if(!t.tag){n=i}if(s){n=n||"#b3b3b3";if(n.indexOf("#")===0){n=n.replace(/[^#]*#([0-9a-f]{6})([0-9a-f]{2})?/i,"#$1")}o=n?`style="border-color: ${n} !important; background-color: unset !important;"`:""}else{o=n?`style="background-color: ${n} !important"`:""}return`<span class="search-input-tag badge bg-secondary me-1" contenteditable="false" data-tag="${t.tag}" ${o}>\n                  <span class="search-input-tag-value" contenteditable="false">${e}${t.term||""}</span>\n                  <i class="ti ti-x cursor-pointer ms-1" title="${__("Delete")}" contenteditable="false"></i>\n               </span>`}tagifyInputNode(t){const e=this.tokenizer.tokenize(t.text());const n=e.getTaggedTerms();const s=e.getUntaggedTerms();let i=null;for(let e=0;e<n.length;e++){const s=n[e];i=$(this.tokenToTagHtml(s)).insertBefore(t);i.data("token",s);this.transformTagTermFromAutocomplete(i)}if(t.data("token")!==undefined&&t.data("token").tag){const n=e.getFullPhrase();t.text(n)}else{for(let e=0;e<s.length;e++){const n=s[e];i=$(this.tokenToTagHtml(n)).insertBefore(t);i.data("token",n)}t.text("")}if(t.text().length===0){if(t.is(":last-child")){t.empty()}else{try{t.remove()}catch(t){}}if(i){this.displayed_input.find(".search-input-tag-input:last-of-type").focus();this.refreshPopover()}}else{this.placeCaretAtEndOfNode(t.get(0))}this.displayed_input.trigger("result_change");return i}transformTagTermFromAutocomplete(t){const e=this.tokenizer.tokenize(t.text());const n=e.getTaggedTerms();const s=n[n.length-1];const i=this.tokenizer.getAutocomplete(s.tag);if(i){i.forEach((e=>{const n=$(`<span>${e}</span>`).text();const i=$(`<span>${s.term}</span>`).text();if(n.localeCompare(i,undefined,{sensitivity:"accent"})===0){s.term=e;t.replaceWith($(this.tokenToTagHtml(s)))}}))}}makeTagEditable(t){if(t&&t.hasClass("search-input-tag")){t.removeClass("search-input-tag");t.addClass("search-input-tag-input");t.attr("contenteditable","true");const e=t.text().trim();t.empty();t.text(e);t.focus();this.placeCaretAtEndOfNode(t.get(0));this.refreshPopover();this.displayed_input.trigger("result_change")}}getSelectedNode(){const t=document.getSelection();let e=null;if(t){e=t.anchorNode;if(e&&e.nodeType===Node.TEXT_NODE){e=e.parentNode}}return e||null}isSelectionUntagged(){const t=this.getSelectedNode();return t!==null&&t.classList.contains("search-input-tag-input")}placeCaretAfterNode(t){if(!t||!t.parentNode){return}const e=t.nextSibling;const n=document.getSelection();const s=n.getRangeAt(0);if(n.rangeCount){s.setStartAfter(e||t);s.collapse(true);n.removeAllRanges();n.addRange(s);this.refreshPopover()}}placeCaretAtStartOfNode(t){if(!t||!t.parentNode){return}const e=document.getSelection();const n=e.getRangeAt(0);if(e.rangeCount){n.setStart(t,0);n.collapse(true);e.removeAllRanges();e.addRange(n);this.refreshPopover()}}placeCaretAtEndOfNode(t){const e=document.getSelection();const n=document.createRange();if(t.lastChild.nodeType===Node.TEXT_NODE){n.setStart(t.lastChild,t.lastChild.length)}else{n.setStart(t,t.childNodes.length)}e.removeAllRanges();e.addRange(n);this.refreshPopover()}placeCaretInDefaultInput(){const t=this.displayed_input.find(".search-input-tag-input:last-of-type");if(t.length>0){this.placeCaretAtStartOfNode(t.get(0))}}getRawInput(){return this.displayed_input.get(0).textContent}refreshPopover(){const t=this.getPopoverContent();this.displayed_input.parent().find(".popover-body").html(t)}getPopoverContent(){const t=this.displayed_input;const e=$(this.getSelectedNode());let n=null;if(this.isSelectionUntagged()){if(e.closest(t)){const t=e.text();const s=document.getSelection().anchorOffset;const i=t.slice(0,s);if(i.endsWith(" ")){return this.getTagsHelperContent()}const o=this.tokenizer.tokenize(i).tokens;const a=Math.max.apply(Math,o.map((t=>t.position)));n=o.find((t=>t.position===a))}}return n&&n.tag?this.getAutocompleteHelperContent(n.tag):this.getTagsHelperContent()}getTagsHelperContent(){const t=this.tokenizer.allowed_tags;const e=$(this.getSelectedNode());let n=(e?e.text():"").trim();const s=n.match(/(?:[^\s"]+|"[^"]*")+/g);n=s?s[s.length-1]:"";let i="";if(Object.keys(t).length>0){i+='<ul class="list-group tags-list">'}$.each(t,((t,e)=>{if(this.options.filter_on_type&&n.length>0&&!t.toLowerCase().startsWith(n.toLowerCase())){return}const s=e.description||"";let o="";const a=Object.keys(e.supported_prefixes||{}).length;$.each(e.supported_prefixes,((t,e)=>{const n=this.tokenizer.options.custom_prefixes[e];let s=n?n.label||e:e;if(e===this.tokenizer.EXCLUSION_PREFIX){s=__("Exclude")}o+=`<button type="button" class="btn btn-outline-secondary btn-sm ${a>1?"ms-1":""} tag-prefix" title="${s}" data-prefix="${e}">${e}</button>`}));i+=`\n            <li class="list-group-item list-group-item-action" style="cursor: pointer" data-tag="${t}">\n                <div class="d-flex flex-grow-1 justify-content-between">\n                   <b>${t}</b>\n                   <span>${o}</span>\n                </div>\n                <div class="text-muted fst-italic">${s}</div>\n            </li>\n         `}));if(Object.keys(t).length>0){i+="</ul>"}return i}getAutocompleteHelperContent(t){t=t.toLowerCase();const e=this.tokenizer.allowed_tags[t];if(e===undefined){return null}const n=$(this.getSelectedNode());const s=(n?n.text():"").trim();const i=this.tokenizer.tokenize(s).getTaggedTerms();const o=(i.length>0?i[0].term:"").trim();let a="";const r=this.tokenizer.getAutocomplete(t);if(r.length>0){a+=`<ul class="list-group term-suggestions-list" data-tag="${t}">`}else{a=`${t.toLowerCase()}: ${e.description}`}$.each(r,((t,e)=>{if(this.options.filter_on_type&&s.length>0&&!e.toLowerCase().startsWith(o.toLowerCase())){return}a+=`<li class="list-group-item list-group-item-action" style="cursor: pointer">${e}</li>`}));if(r.length>0){a+="</ul>"}return a}}